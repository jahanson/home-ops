---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mastodon
  namespace: fediverse
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: mastodon-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        S3_BUCKET_NAME: mastodon
        S3_BUCKET_HOST: s3m.hsn.dev
        S3_BUCKET_ENDPOINT: https://s3m.hsn.dev
        S3_BUCKET_REGION: us-east-1
        S3_ACCESS_KEY: "{{ .minio_mastodon_access_key }}"
        S3_SECRET_KEY: "{{ .minio_mastodon_secret_key }}"
        S3_USER: "{{ .minio_username }}"
        S3_USER_SECRET_KEY: "{{ .minio_password }}"
        SMTP_USER: "{{ .mailgun_smtp_user }}"
        SMTP_PASSWORD: "{{ .mailgun_smtp_password }}"
        REDIS_PASSWORD: "{{ .mastodon_redis_password }}"
        VAPID_PRIVATE_KEY: "{{ .mastodon_vapid_private_key }}"
        VAPID_PUBLIC_KEY: "{{ .mastodon_vapid_public_key }}"
        SECRET_KEY_BASE: "{{ .mastodon_secret_key_base }}"
        OTP_SECRET: "{{ .mastodon_otp_secret }}"
        POSTGRES_PASSWORD: "{{ .mastodon_postgres_password }}"
  dataFrom:
    - extract:
        key: minio-s3m
      rewrite:
        - regexp:
            source: "(.*)"
            target: "minio_$1"
    - extract:
        key: mastodon
      rewrite:
        - regexp:
            source: "(.*)"
            target: "mastodon_$1"
  data:
    - secretKey: mailgun_smtp_user
      remoteRef:
        key: mailgun
        property: mastodon_smtp_user
    - secretKey: mailgun_smtp_password
      remoteRef:
        key: mailgun
        property: mastodon_smtp_password